<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sam - Lesson Adaptations for ND Learners</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333333;
            background: #F4F6F8;
            padding: 40px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #FFFFFF;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        h1 {
            color: #0A3D62;
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .brand {
            color: rgba(10, 61, 98, 0.8);
            font-size: 1rem;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .subtitle {
            color: #888888;
            font-size: 1.2rem;
            font-weight: 400;
        }
        
        .update-banner {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #2ECC71;
            border-radius: 12px;
            padding: 20px;
            margin: 24px 0;
            text-align: left;
        }
        
        .update-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            gap: 12px;
        }
        
        .update-header strong {
            color: #155724;
            font-size: 1.1rem;
        }
        
        .version-badge {
            background: #2ECC71;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .update-content {
            color: #155724;
            line-height: 1.6;
        }
        
        .update-content strong {
            color: #155724;
            display: block;
            margin-bottom: 8px;
        }
        
        .update-content ul {
            margin-left: 20px;
            margin-top: 8px;
        }
        
        .update-content li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .update-content li strong {
            display: inline;
            margin-bottom: 0;
        }
        
        .dismiss-btn {
            background: transparent;
            color: #155724;
            border: 2px solid #155724;
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            line-height: 1;
            transition: all 0.2s ease;
        }
        
        .dismiss-btn:hover {
            background: #155724;
            color: white;
        }
        
        h2 {
            color: #333333;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 16px;
            margin-top: 32px;
        }
        
        h3 {
            color: #333333;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 12px;
            margin-top: 24px;
        }
        
        .section {
            margin-bottom: 32px;
        }
        
        hr {
            border: none;
            border-top: 1px solid #D0D3D4;
            margin: 32px 0;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #0A3D62;
        }
        
        input[type="text"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #D0D3D4;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }
        
        input[type="text"]:focus,
        input[type="password"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #0A3D62;
        }
        
        textarea {
            min-height: 200px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        button {
            background: #F5A623;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        button:hover:not(:disabled) {
            filter: brightness(110%);
        }
        
        button:disabled {
            background: #D0D3D4;
            cursor: not-allowed;
        }
        
        button.secondary {
            background: white;
            color: #0A3D62;
            border: 2px solid #0A3D62;
        }
        
        button.secondary:hover:not(:disabled) {
            background: #0A3D62;
            color: white;
        }
        
        .file-upload {
            border: 2px dashed #D0D3D4;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-upload:hover {
            border-color: #0A3D62;
            background: #f0f8ff;
        }
        
        .file-upload.dragover {
            border-color: #F5A623;
            background: #fff9f0;
        }
        
        #fileInput {
            display: none;
        }
        
        .chat-container {
            border: 1px solid #D0D3D4;
            border-radius: 12px;
            max-height: 600px;
            overflow-y: auto;
            padding: 24px;
            background: #F4F6F8;
            margin-bottom: 16px;
        }
        
        .message {
            margin-bottom: 16px;
            padding: 16px;
            border-radius: 12px;
            line-height: 1.6;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            background: white;
            margin-left: 10%;
            border: 2px solid #D0D3D4;
        }
        
        .message.assistant {
            background: white;
            margin-right: 10%;
            border-left: 4px solid #0A3D62;
        }
        
        .message.system {
            background: #FFF3CD;
            border-left: 4px solid #F1C40F;
            margin: 0 5%;
            font-style: italic;
        }
        
        .message-label {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: #0A3D62;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .copy-btn {
            background: #0A3D62;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.2s ease;
            opacity: 0.7;
        }
        
        .copy-btn:hover {
            opacity: 1;
            filter: brightness(110%);
        }
        
        .copy-btn.copied {
            background: #2ECC71;
        }
        
        .message-content {
            word-wrap: break-word;
        }
        
        /* Markdown rendering styles */
        .message-content h1 {
            font-size: 1.4rem;
            font-weight: 600;
            margin-top: 16px;
            margin-bottom: 12px;
            color: #0A3D62;
        }
        
        .message-content h2 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 16px;
            margin-bottom: 10px;
            color: #0A3D62;
        }
        
        .message-content h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 12px;
            margin-bottom: 8px;
            color: #333333;
        }
        
        .message-content p {
            margin-bottom: 12px;
            line-height: 1.6;
        }
        
        .message-content ul,
        .message-content ol {
            margin-left: 24px;
            margin-bottom: 12px;
        }
        
        .message-content li {
            margin-bottom: 6px;
            line-height: 1.6;
        }
        
        .message-content strong {
            font-weight: 600;
            color: #0A3D62;
        }
        
        .message-content em {
            font-style: italic;
        }
        
        .message-content code {
            background: #0D202F;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }
        
        .message-content pre {
            background: #0D202F;
            color: white;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 12px;
        }
        
        .message-content pre code {
            background: none;
            padding: 0;
        }
        
        .message-content blockquote {
            border-left: 4px solid #0A3D62;
            padding-left: 16px;
            margin-left: 0;
            margin-bottom: 12px;
            color: #555555;
            font-style: italic;
        }
        
        .message-content hr {
            border: none;
            border-top: 1px solid #D0D3D4;
            margin: 16px 0;
        }
        
        .message-content a {
            color: #0A3D62;
            text-decoration: underline;
        }
        
        .message-content a:hover {
            color: #F5A623;
        }
        
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 12px;
        }
        
        .message-content th,
        .message-content td {
            border: 1px solid #D0D3D4;
            padding: 8px;
            text-align: left;
        }
        
        .message-content th {
            background: #F4F6F8;
            font-weight: 600;
        }
        
        .response-input {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .response-input input {
            flex: 1;
        }
        
        .hidden {
            display: none;
        }
        
        .warning {
            background: #FFF3CD;
            border: 2px solid #F1C40F;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            color: #856404;
        }
        
        .success {
            background: #d4edda;
            border: 2px solid #2ECC71;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            border: 2px solid #E74C3C;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            color: #721c24;
        }
        
        .info {
            background: #d1ecf1;
            border: 2px solid #0A3D62;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            color: #0c5460;
        }
        
        .loading {
            text-align: center;
            padding: 24px;
            color: #888888;
        }
        
        .spinner {
            border: 3px solid #D0D3D4;
            border-top: 3px solid #F5A623;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 16px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .download-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        .download-buttons button {
            background: #2ECC71;
            flex: 1;
            min-width: 200px;
        }
        
        .download-buttons button:hover {
            filter: brightness(110%);
        }
        
        .help-text {
            font-size: 14px;
            color: #888888;
            margin-top: 8px;
            line-height: 1.5;
        }
        
        code {
            background: #0D202F;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            margin-bottom: 24px;
        }
        
        a {
            color: #0A3D62;
            text-decoration: underline;
            transition: color 0.2s ease;
        }
        
        a:hover {
            color: #F5A623;
        }
        
        strong {
            color: #0A3D62;
        }
        
        .stage-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 32px;
            padding: 16px;
            background: #F4F6F8;
            border-radius: 12px;
        }
        
        .stage {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #888888;
            background: white;
            margin: 0 4px;
            transition: all 0.3s ease;
        }
        
        .stage.active {
            background: #0A3D62;
            color: white;
        }
        
        .stage.complete {
            background: #2ECC71;
            color: white;
        }
        
        .config-section {
            background: #F4F6F8;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        
        .config-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        /* Accessibility improvements */
        *:focus {
            outline: 2px solid #F5A623;
            outline-offset: 2px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 20px;
            }
            
            .container {
                padding: 24px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .update-banner {
                padding: 16px;
            }
            
            .update-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .update-content ul {
                margin-left: 16px;
            }
            
            .message.user,
            .message.assistant {
                margin-left: 0;
                margin-right: 0;
            }
            
            .download-buttons {
                flex-direction: column;
            }
            
            .download-buttons button {
                width: 100%;
            }
            
            .stage-indicator {
                flex-direction: column;
            }
            
            .stage {
                margin: 4px 0;
            }
            
            .config-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Sam - Lesson Adaptations for ND Learners</h1>
            <p class="brand">Pilot Version ‚Ä¢ Feedback Welcome ‚Ä¢ Nov 2025</p>
            
            <div class="update-banner" id="updateBanner">
                <div class="update-header">
                    <strong>üéâ Updated: 26 November 2025</strong>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span class="version-badge">v2.1</span>
                        <button onclick="dismissUpdate()" class="dismiss-btn" title="Dismiss this update notice">‚úï</button>
                    </div>
                </div>
                <div class="update-content">
                    <strong>What's New:</strong>
                    <ul>
                        <li><strong>Improved Readability</strong> - Sam's responses now display with proper formatting: bold text, bullet points, headers, and clear section breaks</li>
                        <li><strong>Copy for Word Button</strong> - Click "Copy for Word" on any Sam response to get clean text ready to paste into Word documents (no markdown symbols!)</li>
                        <li><strong>Better Visual Hierarchy</strong> - Recommendations and analysis are now much easier to scan and reference</li>
                        <li><strong>Enhanced Stage Tracking</strong> - Visual progress indicator shows you where you are in the 7-stage workflow</li>
                    </ul>
                </div>
            </div>
            
            <p class="subtitle">Upload a lesson plan or assessment and Sam will generate two adapted versions: one optimised for autistic pupils (emphasising structure and predictability) and one for pupils with a PDA profile (emphasising autonomy and choice). Both versions maintain your original learning objectives while removing access barriers.</p>
        </header>
        
        <!-- Configuration Section -->
        <div id="configSection" class="hidden">
            <div class="config-section">
                <h2>‚öôÔ∏è Configuration</h2>
                <p class="help-text">Configure your backend API endpoint. This should point to your Flask proxy server.</p>
                
                <div class="config-row">
                    <div>
                        <label for="apiEndpoint">API Endpoint:</label>
                        <input type="text" id="apiEndpoint" placeholder="/api/chat" value="/api/chat" />
                        <p class="help-text">Default: /api/chat (Vercel deployment)</p>
                    </div>
                </div>
                
                <button onclick="saveConfig()">Save Configuration</button>
                <button onclick="hideConfig()" class="secondary">Cancel</button>
            </div>
        </div>
        
        <!-- Setup Section -->
        <div id="setupSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin: 0;">Upload your lesson plan</h2>
                <button onclick="showConfig()" class="secondary" style="padding: 8px 16px;">‚öôÔ∏è Configure</button>
            </div>
            
            <section class="section">
                <label>Upload File:</label>
                <div class="file-upload" id="fileUploadArea">
                    <p style="font-size: 1.2rem; margin-bottom: 8px;">üìÑ Click to select a file or drag and drop</p>
                    <p style="font-size: 14px; color: #888888;">Supported formats: .txt, .docx, .pdf</p>
                </div>
                <input type="file" id="fileInput" accept=".txt,.docx,.pdf" />
                <div id="fileStatus"></div>
            </section>
            
            <section class="section">
                <label for="lessonText">Or paste lesson plan text:</label>
                <textarea id="lessonText" placeholder="Paste your lesson plan here..."></textarea>
                <p class="help-text">You can edit the extracted text above before starting the adaptation.</p>
            </section>
            
            <hr>
            
            <button id="startBtn" onclick="startAdaptation()">Start Adaptation</button>
        </div>
        
        <!-- Chat Section -->
        <div id="chatSection" class="hidden">
            <!-- Stage Indicator -->
            <div class="stage-indicator">
                <div class="stage" id="stage0">Intake</div>
                <div class="stage" id="stage1">Analysis</div>
                <div class="stage" id="stage2">Recommendations</div>
                <div class="stage" id="stage3">Approval</div>
                <div class="stage" id="stage4">Creation</div>
                <div class="stage" id="stage5">Complete</div>
            </div>
            
            <h2>Conversation with Sam</h2>
            <div class="chat-container" id="chatContainer"></div>
            
            <div class="response-input">
                <input type="text" id="userResponse" placeholder="Type your response..." onkeypress="handleKeyPress(event)" />
                <button onclick="sendResponse()">Send</button>
            </div>
            
            <div id="downloadSection" class="hidden">
                <div class="success">
                    <strong>‚úÖ Adaptation complete!</strong><br>
                    Download your adapted versions below. Both maintain the original learning objectives and assessment criteria while addressing access barriers.
                </div>
                <div class="download-buttons">
                    <button onclick="downloadFile('autism')">üì• Download Autism Version</button>
                    <button onclick="downloadFile('pda')">üì• Download PDA Version</button>
                </div>
            </div>
            
            <hr>
            
            <button onclick="resetApp()" class="secondary">Start New Adaptation</button>
        </div>
    </div>

    <!-- External libraries for file processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Sanitize HTML to prevent XSS -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Configure marked.js for better markdown rendering
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,        // Convert single line breaks to <br>
                gfm: true,          // GitHub Flavored Markdown
                headerIds: false,   // Don't add IDs to headers
                mangle: false,      // Don't escape autolinked email addresses
            });
        }
        
        // State management
        let conversationHistory = [];
        let lessonContent = '';
        let uploadedFile = null;
        let autismVersion = '';
        let pdaVersion = '';
        let currentStage = 0;
        let apiEndpoint = '/api/chat'; // Default to same domain /api/chat for Vercel
        
        // Load saved config
        window.onload = function() {
            const savedEndpoint = localStorage.getItem('apiEndpoint');
            if (savedEndpoint) {
                apiEndpoint = savedEndpoint;
                document.getElementById('apiEndpoint').value = savedEndpoint;
            }
            
            // Check if update banner has been dismissed
            const updateDismissed = localStorage.getItem('updateBannerDismissed_v2.1');
            if (updateDismissed === 'true') {
                const banner = document.getElementById('updateBanner');
                if (banner) {
                    banner.style.display = 'none';
                }
            }
        };
        
        // Dismiss update banner
        function dismissUpdate() {
            const banner = document.getElementById('updateBanner');
            banner.style.transition = 'opacity 0.3s ease';
            banner.style.opacity = '0';
            setTimeout(() => {
                banner.style.display = 'none';
            }, 300);
            localStorage.setItem('updateBannerDismissed_v2.1', 'true');
        }
        
        // Configuration functions
        function showConfig() {
            document.getElementById('configSection').classList.remove('hidden');
            document.getElementById('setupSection').classList.add('hidden');
        }
        
        function hideConfig() {
            document.getElementById('configSection').classList.add('hidden');
            document.getElementById('setupSection').classList.remove('hidden');
        }
        
        function saveConfig() {
            const endpoint = document.getElementById('apiEndpoint').value.trim();
            if (!endpoint) {
                alert('Please enter an API endpoint');
                return;
            }
            
            apiEndpoint = endpoint;
            localStorage.setItem('apiEndpoint', endpoint);
            
            const statusDiv = document.getElementById('fileStatus');
            statusDiv.innerHTML = '<div class="success">‚úÖ Configuration saved successfully</div>';
            setTimeout(() => {
                hideConfig();
                statusDiv.innerHTML = '';
            }, 2000);
        }
        
        // Stage management
        function updateStage(stage) {
            currentStage = stage;
            for (let i = 0; i <= 5; i++) {
                const stageElement = document.getElementById(`stage${i}`);
                if (i < stage) {
                    stageElement.classList.add('complete');
                    stageElement.classList.remove('active');
                } else if (i === stage) {
                    stageElement.classList.add('active');
                    stageElement.classList.remove('complete');
                } else {
                    stageElement.classList.remove('active', 'complete');
                }
            }
        }
        
        // File upload handling
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        
        fileUploadArea.onclick = () => fileInput.click();
        
        fileInput.onchange = async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            uploadedFile = file;
            const statusDiv = document.getElementById('fileStatus');
            statusDiv.innerHTML = `<div class="info">Processing ${file.name}...</div>`;
            
            try {
                if (file.name.endsWith('.txt')) {
                    lessonContent = await readTextFile(file);
                    statusDiv.innerHTML = `<div class="success">‚úÖ Extracted text from ${file.name} (${lessonContent.length} characters)</div>`;
                } else if (file.name.endsWith('.docx')) {
                    lessonContent = await extractTextFromDocx(file);
                    statusDiv.innerHTML = `<div class="success">‚úÖ Extracted text from ${file.name} (${lessonContent.length} characters)</div>`;
                } else if (file.name.endsWith('.pdf')) {
                    lessonContent = await extractTextFromPdf(file);
                    statusDiv.innerHTML = `<div class="success">‚úÖ Extracted text from ${file.name} (${lessonContent.length} characters)</div>`;
                }
                
                // Show preview in textarea
                document.getElementById('lessonText').value = lessonContent;
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Error processing file: ${error.message}</div>`;
                console.error('File processing error:', error);
            }
        };
        
        // File reading functions
        function readTextFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('Failed to read text file'));
                reader.readAsText(file);
            });
        }
        
        async function extractTextFromDocx(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                        if (result.value) {
                            resolve(result.value);
                        } else {
                            reject(new Error('No text extracted from Word document'));
                        }
                    } catch (error) {
                        reject(new Error('Failed to extract text from Word document: ' + error.message));
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read Word file'));
                reader.readAsArrayBuffer(file);
            });
        }
        
        async function extractTextFromPdf(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const typedArray = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument(typedArray).promise;
                        let fullText = '';
                        
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText + '\n\n';
                        }
                        
                        if (fullText.trim()) {
                            resolve(fullText);
                        } else {
                            reject(new Error('No text extracted from PDF'));
                        }
                    } catch (error) {
                        reject(new Error('Failed to extract text from PDF: ' + error.message));
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read PDF file'));
                reader.readAsArrayBuffer(file);
            });
        }
        
        // Drag and drop
        fileUploadArea.ondragover = function(e) {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        };
        
        fileUploadArea.ondragleave = function() {
            fileUploadArea.classList.remove('dragover');
        };
        
        fileUploadArea.ondrop = function(e) {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            fileInput.files = e.dataTransfer.files;
            fileInput.onchange({ target: fileInput });
        };
        
        // Handle Enter key in response input
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendResponse();
            }
        }
        
        // Add message to chat
        function addMessageToChat(role, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const labelDiv = document.createElement('div');
            labelDiv.className = 'message-label';
            
            const labelText = document.createElement('span');
            labelText.textContent = role === 'user' ? 'You' : (role === 'system' ? 'System' : 'Sam');
            labelDiv.appendChild(labelText);
            
            // Add copy button for assistant messages
            if (role === 'assistant') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'Copy for Word';
                copyBtn.onclick = function() {
                    copyToClipboard(content, copyBtn);
                };
                labelDiv.appendChild(copyBtn);
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Render markdown for assistant and system messages
            if (role === 'assistant' || role === 'system') {
                // Configure marked options
                marked.setOptions({
                    breaks: true,  // Convert \n to <br>
                    gfm: true,     // GitHub Flavored Markdown
                });
                
                // Convert markdown to HTML
                const rawHtml = marked.parse(content);
                
                // Sanitize HTML to prevent XSS attacks
                const cleanHtml = DOMPurify.sanitize(rawHtml);
                
                // Set the sanitized HTML
                contentDiv.innerHTML = cleanHtml;
            } else {
                // For user messages, just show plain text
                contentDiv.textContent = content;
            }
            
            messageDiv.appendChild(labelDiv);
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Copy text to clipboard (clean version for Word)
        function copyToClipboard(markdownText, button) {
            // Convert markdown to plain text suitable for Word
            let plainText = markdownText
                // Remove HTML tags if any slipped through
                .replace(/<[^>]*>/g, '')
                // Convert headers to plain text with blank line after
                .replace(/^#{1,6}\s+(.+)$/gm, '\n$1\n')
                // Remove bold markers ** but keep text
                .replace(/\*\*(.+?)\*\*/g, '$1')
                // Remove italic markers * or _ but keep text  
                .replace(/[*_](.+?)[*_]/g, '$1')
                // Remove strikethrough
                .replace(/~~(.+?)~~/g, '$1')
                // Remove inline code backticks but keep text
                .replace(/`([^`]+)`/g, '$1')
                // Remove code block markers but keep content
                .replace(/```[\s\S]*?```/g, function(match) {
                    return match.replace(/```[a-z]*\n?/g, '').replace(/```/g, '');
                })
                // Convert bullet points to Word-friendly bullets
                .replace(/^\s*[-*+]\s+/gm, '‚Ä¢ ')
                // Keep numbered lists but ensure proper formatting
                .replace(/^\s*(\d+)\.\s+/gm, '$1. ')
                // Remove blockquote markers
                .replace(/^\s*>\s+/gm, '')
                // Remove horizontal rules
                .replace(/^[-*_]{3,}\s*$/gm, '')
                // Remove link formatting [text](url) but keep text
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
                // Remove image syntax
                .replace(/!\[([^\]]*)\]\([^)]+\)/g, '')
                // Clean up multiple blank lines (max 2)
                .replace(/\n{3,}/g, '\n\n')
                // Remove leading/trailing whitespace
                .trim();
            
            // Copy to clipboard
            navigator.clipboard.writeText(plainText).then(function() {
                // Show success feedback
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                button.classList.add('copied');
                
                setTimeout(function() {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(function(err) {
                // Fallback: create a temporary textarea
                const textarea = document.createElement('textarea');
                textarea.value = plainText;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    button.textContent = '‚úì Copied!';
                    button.classList.add('copied');
                    setTimeout(function() {
                        button.textContent = 'Copy for Word';
                        button.classList.remove('copied');
                    }, 2000);
                } catch (err2) {
                    alert('Failed to copy. Please select and copy manually.');
                    console.error('Copy failed:', err2);
                }
                document.body.removeChild(textarea);
            });
        }
        
        // Add loading indicator
        function addLoadingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.className = 'message assistant';
            loadingDiv.innerHTML = `
                <div class="message-label">Sam</div>
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Thinking...</p>
                </div>
            `;
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Remove loading indicator
        function removeLoadingIndicator() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
        }
        
        // Start adaptation
        async function startAdaptation() {
            const manualText = document.getElementById('lessonText').value.trim();
            
            if (!lessonContent && !manualText) {
                alert('Please upload a file or paste lesson plan text.');
                return;
            }
            
            // Use manual text if provided
            if (manualText) {
                lessonContent = manualText;
            }
            
            // Hide setup, show chat
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('chatSection').classList.remove('hidden');
            
            // Initialize conversation
            conversationHistory = [];
            updateStage(0);
            
            // Add system message
            addMessageToChat('system', 'Starting adaptation process. Sam will now analyse your lesson plan and ask any clarifying questions needed.');
            
            // Send first message
            await sendMessageToClaude(lessonContent, true);
        }
        
        // Send message to Claude via backend
        async function sendMessageToClaude(message, isInitial = false) {
            try {
                addLoadingIndicator();
                
                // Build the message history
                const messages = [...conversationHistory];
                
                if (isInitial) {
                    // First message includes the lesson plan
                    messages.push({
                        role: 'user',
                        content: `Here is the lesson plan to adapt:\n\n${message}`
                    });
                } else {
                    // Subsequent messages
                    messages.push({
                        role: 'user',
                        content: message
                    });
                }
                
                // Send to backend
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: messages
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                removeLoadingIndicator();
                
                // Add Claude's response to chat
                const assistantMessage = data.content[0].text;
                addMessageToChat('assistant', assistantMessage);
                
                // Update conversation history
                conversationHistory.push({ role: 'user', content: message });
                conversationHistory.push({ role: 'assistant', content: assistantMessage });
                
                // Check for stage progression keywords
                detectStageProgression(assistantMessage);
                
                // Check for file creation (download links)
                if (assistantMessage.includes('computer://') || assistantMessage.includes('Download')) {
                    document.getElementById('downloadSection').classList.remove('hidden');
                    updateStage(5);
                }
                
            } catch (error) {
                removeLoadingIndicator();
                addMessageToChat('system', `‚ùå Error: ${error.message}. Please check your backend is running and configured correctly.`);
                console.error('API Error:', error);
            }
        }
        
        // Detect stage progression from Claude's response
        function detectStageProgression(message) {
            const lowerMessage = message.toLowerCase();
            
            if (currentStage === 0 && (lowerMessage.includes('analysis') || lowerMessage.includes('analyse'))) {
                updateStage(1);
            } else if (currentStage === 1 && lowerMessage.includes('recommendation')) {
                updateStage(2);
            } else if (currentStage === 2 && lowerMessage.includes('would you like me to generate')) {
                updateStage(3);
            } else if (currentStage === 3 && (lowerMessage.includes('autism-friendly') || lowerMessage.includes('version a'))) {
                updateStage(4);
            }
        }
        
        // Send user response
        async function sendResponse() {
            const input = document.getElementById('userResponse');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Clear input
            input.value = '';
            
            // Send to Claude
            await sendMessageToClaude(message);
        }
        
        // Download file (placeholder - needs backend support)
        function downloadFile(version) {
            alert(`Download functionality requires backend support. Version: ${version}`);
            // In a full implementation, this would request the file from the backend
            // which has access to the /mnt/user-data/outputs/ directory
        }
        
        // Reset app
        function resetApp() {
            if (confirm('Are you sure you want to start a new adaptation? This will clear the current conversation.')) {
                // Clear state
                conversationHistory = [];
                lessonContent = '';
                uploadedFile = null;
                autismVersion = '';
                pdaVersion = '';
                currentStage = 0;
                
                // Clear UI
                document.getElementById('lessonText').value = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('fileStatus').innerHTML = '';
                document.getElementById('chatContainer').innerHTML = '';
                document.getElementById('userResponse').value = '';
                
                // Hide chat, show setup
                document.getElementById('chatSection').classList.add('hidden');
                document.getElementById('setupSection').classList.remove('hidden');
                document.getElementById('downloadSection').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
